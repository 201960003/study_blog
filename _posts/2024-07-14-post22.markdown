---
layout: post
title:  âŒœHTMLâŒŸ ì›¹ì—ì„œ FCM ë³´ë‚´ê¸°
date:   2024-07-14 +0900
categories: [HTML, FCM, Javascript]
---

node.js í™˜ê²½ì—ì„œ FCM ë³´ë‚´ê¸°ë¥¼ í•˜ë ¤ê³  í•©ë‹ˆë‹¤.
FCMì€ HTTPv1(ë²„ì „)ìœ¼ë¡œ ê¸°ì¤€ìœ¼ë¡œ ì‘ì„±í•˜ì˜€ìŠµë‹ˆë‹¤.

ì›¹ í‘¸ì‹œëŠ” ìš´ì˜í•˜ëŠ” í˜ì´ì§€ì—ëŠ” ì ‘ì†ì€ ì•ˆí•´ë„ ë˜ì§€ë§Œ ë¸Œë¼ìš°ì €ëŠ” ì‹¤í–‰ì‹œì¼œì•¼ì§€ í‘¸ì‹œë©”ì„¸ì§€ë¥¼ ì†¡ì‹ í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

í´ë” êµ¬ì¡°ëŠ” ì•„ë˜ì˜ ì‚¬ì§„ì²˜ëŸ¼ í–ˆìŠµë‹ˆë‹¤.



<center>
  <img src="{{ site.baseurl }}_includes/img/post22/1.png" alt="ì²«ë²ˆì§¸ ì‚¬ì§„">
</center>



### 1. server ë‹¨ ì½”ë“œ app.js

```javascript
const express = require('express');
const path = require('path');
const { JWT } = require('google-auth-library');
const fs = require('fs').promises;
var bodyParser = require("body-parser");
const axios = require('axios');

const app = express();
const PORT = 3000;

app.use(bodyParser.json());
app.use(express.json());
app.use(express.urlencoded({ extended: false }));
app.use(express.static(path.join(__dirname, 'public')));

// Firebase Access Token ê°€ì ¸ì˜¤ê¸° í•¨ìˆ˜
const firebaseMessagingScope = 'https://www.googleapis.com/auth/firebase.messaging';

async function getAccessToken() {
  try {
    const json = await fs.readFile('public/<project>-firebase-adminsdk-uum70-4ab63d0963.json', 'utf8');
    // access tokenì„ ê°€ì ¸ì˜¤ê¸° ìœ„í•´ json íŒŒì¼ ì½ëŠ” ë¶€ë¶„
    const credentials = JSON.parse(json);

    const client = new JWT(
      credentials.client_email,
      null,
      credentials.private_key,
      [firebaseMessagingScope]
    );

    await client.authorize();
    const accessToken = client.credentials.access_token;
    return accessToken;
  } catch (error) {
    console.error('Error getting access token:', error);
    throw error;
  }
}

// ë£¨íŠ¸ ê²½ë¡œ
app.get('/', (req, res) => {
  res.sendFile(path.join(__dirname, 'public', 'index.html'));
});


// í‘¸ì‹œ ì•Œë¦¼ ë³´ë‚´ê¸° ë¼ìš°íŠ¸
app.post('/send-notification', async (req, res) => {
  const token = req.body.token;
  const title = req.body.title;
  const content = req.body.content;

  const access_token = await getAccessToken(); // ìœ„ì—ì„œ ì„ ì–¸í•œ access token ê°€ì ¸ì˜¤ëŠ” í•¨ìˆ˜ ì‹¤í–‰

  try {
    const response = await axios.post('https://fcm.googleapis.com/v1/projects/<your_porject_id>/messages:send', {
      //http v1 ë¶€í„° ìœ„ì˜ urlì²˜ëŸ¼ ì‚¬ìš©í•©ë‹ˆë‹¤. 
      message: {
        token: token,
        notification: {
          title: title,
          body: content,
        },
      },
    }, {
      headers: {
        'Content-Type': 'application/json; charset=UTF-8',
        'Authorization': 'Bearer ' + access_token,
      }
    });
    if (response.status === 200) {
      res.send('í‘¸ì‹œ ë©”ì‹œì§€ê°€ ì„±ê³µì ìœ¼ë¡œ ì „ì†¡ë˜ì—ˆìŠµë‹ˆë‹¤.');
    } else {
      res.status(500).send('í‘¸ì‹œ ë©”ì‹œì§€ ì „ì†¡ ì‹¤íŒ¨: ' + response.statusText);
    }
  } catch (e) {
    console.error('sendPushNotification error:', e.toString());
  }
});


// ì„œë²„ ì‹œì‘
app.listen(PORT, () => {
  console.log(`ì„œë²„ì‹¤í–‰ http://localhost:${PORT}`);
});

```
access tokenì„ ë°œê¸‰ë°›ê¸° ìœ„í•´ 'google-auth-library' íŒ¨í‚¤ì§€ë¥¼ ì„¤ì¹˜í•´ì„œ ì‚¬ìš©í•©ë‹ˆë‹¤.

<br><br>

### 2. ì›¹ í˜ì´ì§€ index.html
```HTML
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Firebase Cloud Messaging Example</title>
     <!-- Firebase JavaScript SDK -->
     <script src="https://www.gstatic.com/firebasejs/8.6.1/firebase-app.js"></script>
     <script src="https://www.gstatic.com/firebasejs/8.6.1/firebase-messaging.js"></script>
     
     <!-- Firebase ì´ˆê¸°í™” ë° ì„œë¹„ìŠ¤ ì›Œì»¤ ë“±ë¡ -->
     <script src="firebase_init.js"></script>

     <!-- jquery -->
     <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
</head>
<body>
    <h1>Push Notification</h1>
    <textarea id="token-input" placeholder="Enter token"></textarea>
    <br><br>
    <input type="text" id="title-input" placeholder="Enter title">
    <br><br>
    <textarea id="content-input" placeholder="Enter content"></textarea>
    <br><br>
    <button id="send-button">Send Push Notification</button>
    <script>
        $(document).ready(function () {
            $('#send-button').click(function () {
                const token = $('#token-input').val(); 
                const title = $('#title-input').val();
                const content = $('#content-input').val();
                // input, textarea ì— ì…ë ¥ëœ value ë¥¼ /send-notification'
                $.ajax({
                    url: '/send-notification', 
                    type: 'POST',
                    data: {
                        token: token,
                        title: title,
                        content: content
                    },
                    success: function (response) {
                        console.log('Push notification sent successfully');
                    },
                    error: function (error) {
                        console.error('Failed to send push notification:', error);
                    }
                });
            });
        });
    </script>
</body>
</html>
```
ì´ htmlíŒŒì¼ì´ public ì•ˆì— ìˆëŠ” ì´ìœ ëŠ” app.js ì• ì„œ res.sendFileë¡œ íŒŒì¼ì„ ì „ë‹¬í•˜ê³  view í´ë”ë¥¼ app.jsì—ì„œ ë”°ë¡œ ì§€ì •ì„ ì•ˆí–ˆê¸° ë•Œë¬¸ì…ë‹ˆë‹¤.

<br><br>

### 3. ì›¹ í˜ì´ì§€ index.htmlì— ìˆëŠ” firebase_init.js
```javascript
// Firebase ì„¤ì •
    const firebaseConfig = {
    apiKey: "-.....-9RtY",
    authDomain: "<your_project_id>.firebaseapp.com",
    projectId: "<your_project_id>",
    storageBucket: "<your_project_id>.appspot.com",
    messagingSenderId: "........",
    appId: ".................",
    measurementId: "G-....."
  };

// Firebase ì´ˆê¸°í™”
firebase.initializeApp(firebaseConfig);

// VAPID í‚¤ ì„¤ì • (Firebase Cloud Messagingì„ ìœ„í•´ í•„ìš”)
const vapidKey = '.....-Wgu.....';

// Firebase Messaging ì¸ìŠ¤í„´ìŠ¤ ê°€ì ¸ì˜¤ê¸°
const messaging = firebase.messaging();

// ì„œë¹„ìŠ¤ ì›Œì»¤ ë“±ë¡ ë° ì²˜ë¦¬
if ('serviceWorker' in navigator) {
  navigator.serviceWorker.register('/firebase-messaging-sw.js', {
    scope: '/firebase-cloud-messaging-push-scope'
  }).then((registration) => {

    // FCM ë©”ì‹œì§€ ìˆ˜ì‹  í•¸ë“¤ëŸ¬ ë“±ë¡
    messaging.onMessage((payload) => {
      
      // ì•Œë¦¼ ì»¤ìŠ¤í„°ë§ˆì´ì§• ê°€ëŠ¥
      const notificationTitle = payload.notification.title;
      const notificationOptions = {
        body: payload.notification.body,
      };
  
      registration.showNotification(notificationTitle, notificationOptions);
    });
  }).catch((err) => {
    console.error('Service Worker registration failed:', err);
  });
}

// ì‚¬ìš©ìì—ê²Œ ì•Œë¦¼ í—ˆìš© ì—¬ë¶€ ë¬»ê¸°
function requestPermission() {
  Notification.requestPermission().then((permission) => {
    if (permission === "granted") {
      // ì•Œë¦¼ ê¶Œí•œ í—ˆìš© ì‹œ ì¶”ê°€ ì‘ì—… ìˆ˜í–‰ ê°€ëŠ¥
      getFCMToken();
    }
  });
}

// FCM í† í° ë°›ê¸°
function getFCMToken() {
  messaging.getToken({ vapidKey: vapidKey }).then((currentToken) => {
    if (currentToken) {
      console.log("FCM Token:", currentToken);
      // í† í°ì„ ì„œë²„ë¡œ ì „ì†¡í•˜ê³  UI ì—…ë°ì´íŠ¸ ë“± ì¶”ê°€ ì‘ì—… ìˆ˜í–‰ ê°€ëŠ¥

      // ì§ì ‘ #token-input textareaì— ê°’ ë„£ëŠ” ë¶€ë¶„
      document.getElementById('token-input').value = currentToken
    } else {
      console.log("No registration token available. Request permission to generate one.");
    }
  }).catch((err) => {
    console.log("An error occurred while retrieving token. ", err);
  });
}

// ì´ˆê¸°í™” í›„ ì•Œë¦¼ ê¶Œí•œ ìš”ì²­
requestPermission();
```
getFCMToken() í•¨ìˆ˜ì— ìˆëŠ” document.getElementById('token-input').value = currentToken ë¶€ë¶„ì´
index.htmlì— ìˆëŠ” id="token-input"ì¸ textareaì— ê°’ì„ ë„£ëŠ” ë¶€ë¶„ì…ë‹ˆë‹¤.

ê·¸ë¦¬ê³  service workerë¼ëŠ” ê²ƒì´ ìˆëŠ”ë° í•´ë‹¹ ì›¹ í˜ì´ì§€ì— ì ‘ì†ì„ ì•ˆí•´ë„ í‘¸ì‹œë©”ì‹œì§€ë¥¼ ì†¡ì‹ í•˜ê¸° ìœ„í•´ ê¼­ í•„ìš”í•œ ì‘ì—…ì…ë‹ˆë‹¤. ì›¹ í˜ì´ì§€ì— ë“±ë¡ì´ ë˜ì–´ì•¼ ê°€ëŠ¥í•©ë‹ˆë‹¤.

firebaseì—ì„œ fcm ë³´ë‚¼ ë•ŒëŠ” firebase-messaging-sw.jsë¼ëŠ” íŒŒì¼ ëª…ì˜ service worker íŒŒì¼ì´ ìˆì–´ì•¼ í•©ë‹ˆë‹¤.
í•´ë‹¹ íŒŒì¼ì€ node.js í™˜ê²½ì—ì„œ ì‘ì—…ì„ í•˜ê¸° ë•Œë¬¸ì— public í´ë” ì•ˆì— ìœ„ì¹˜ì‹œì¼œì•¼ í•©ë‹ˆë‹¤.

<br><br>

### 4. firebase-messaging-sw.js íŒŒì¼ ë‚´ìš©
```javascript
  importScripts('https://www.gstatic.com/firebasejs/9.15.0/firebase-app-compat.js');
  importScripts('https://www.gstatic.com/firebasejs/9.15.0/firebase-messaging-compat.js');

  // Firebase ì„¤ì •
    const firebaseConfig = {
      apiKey: "-.....-9RtY",
      authDomain: "<your_project_id>.firebaseapp.com",
      projectId: "<your_project_id>",
      storageBucket: "<your_project_id>.appspot.com",
      messagingSenderId: "........",
      appId: ".................",
      measurementId: "G-....."
    };
    
  // Firebase ì´ˆê¸°í™”
  firebase.initializeApp(firebaseConfig);

  // Firebase Messaging ì¸ìŠ¤í„´ìŠ¤ ê°€ì ¸ì˜¤ê¸°
  const messaging = firebase.messaging();

  // ë°±ê·¸ë¼ìš´ë“œ ë©”ì‹œì§€ í•¸ë“¤ëŸ¬ ì„¤ì •
  messaging.onBackgroundMessage(function(payload) {
    console.log('[firebase-messaging-sw.js] Received background message ', payload);

    // ì•Œë¦¼ ì»¤ìŠ¤í„°ë§ˆì´ì§• ê°€ëŠ¥
    const notificationTitle = payload.notification.title;
    const notificationOptions = {
      body: payload.notification.body,
    };

    self.registration.showNotification(notificationTitle, notificationOptions);
  });

```

<br><br>

### 5. firebase-adminsdk-uum70-4ab63d0963.json ëŒ€ëµì ì¸ íŒŒì¼ ë‚´ìš©
```json
{
  "type": ".....",
  "project_id": "<your_project_id>",
  "private_key_id": ".............",
  "private_key": "-----BEGIN PRIVATE KEY----lUiRok/.....",
  "client_email": "firebase-admin......0@<your_project_id>.iam.....com",
  "client_id": ".......",
  "auth_uri": "https://a..................",
  "token_uri": "https://...............n",
  "auth_provider_x509_cert_url": "........",
  "client_x509_cert_url": "https://www......%<your_project_id>.iam......com",
  "universe_domain": "googleapis.com"
}
```
firebase-adminsdk-uum70-4ab63d0963.jsonì€ firebaseì—ì„œ í”„ë¡œì íŠ¸ ì„¤ì •ì—ì„œ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.


### 6. íŒ¨í‚¤ì§€ ì •ë³´
```json
{
  "name": "node_fcm",
  "version": "1.0.0",
  "description": "",
  "main": "app.js",
  "scripts": {
    "start": "node app.js",
    "test": "echo \"Error: no test specified\" && exit 1"
  },
  "author": "",
  "license": "ISC",
  "dependencies": {
    "@onesignal/node-onesignal": "^2.0.1-beta1",
    "axios": "^1.7.2",
    "body-parser": "^1.20.2",
    "ejs": "^3.1.10",
    "express": "^4.18.2",
    "google-auth-library": "^9.11.0",
    "path": "^0.12.7"
  }
}

```

<br><br><br>

### ğŸ§ ì˜¤ëŠ˜ì˜ ì†Œê°ì€?
ì²˜ìŒìœ¼ë¡œ ì›¹ í‘¸ì‹œë¥¼ í•´ë³´ëŠ” ë° ë„ˆë¬´ êµ¬ê¸€ì´ë‚˜ ê¹ƒí—ˆë¸Œ ê°™ìœ¼ëŠ ë¡œê·¸ì¸ì„ í•´ì„œ í† í°ì„ ì–»ì–´ì˜¤ëŠ” ê²ƒì´ ì•„ë‹Œ ë¡œê·¸ì¸ ì—†ì´ í•´ë‹¹ ì‚¬ì´íŠ¸ë¥¼ ì ‘ì†í–ˆì„ë•Œ í† í°ì„ ê°€ì ¸ì˜¤ëŠ” ë°©ë²•ì´ ìƒì†Œí–ˆì—ˆìŠµë‹ˆë‹¤.

ë‹¤ë¥¸ ì˜ˆì œë“¤ì€ firebase-admin íŒ¨í‚¤ì§€ë¥¼ ì‚¬ìš©í•´ì„œ í† í°ì„ ê°€ì ¸ì˜¤ë”ë¼ê³ ìš” ã… ã… ã…  ì–´ë–»ê²Œ ì ‘ê·¼í•´ì•¼í•˜ëŠ” ì§€ ì²˜ìŒ ê°ì´ ë„ˆë¬´ ì•ˆì¡í˜”ì–´ì„œ 3ì¼ ë°¤ ê¼¬ë°• ìƒˆì„œ ê²¨ìš° í•´ê²°í–ˆë˜ ê²ƒ ê°™ìŠµë‹ˆë‹¤.. ì´ê±´ ì§„ì§œ ë„ˆë¬´ ì–´ë ¤ì› ì–´ìš” ê·¸ë˜ë„ ë‹¤ìŒ í”„ë¡œì íŠ¸ë¥¼ í•  ë•Œ ì¢€ ë” ì‰½ê²Œ ì ‘ê·¼ í•  ìˆ˜ ìˆê² ì£ ?? íœ´íœ´ ê·¸ë‚˜ë§ˆ ê·¸ ìƒê°ì´ ì œê°€ ì¼í•˜ë©´ì„œ í˜ì´ ë©ë‹ˆë‹¤.
<br>